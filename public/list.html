<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vignanateja EM | Student Directory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
    .student-card { transition: all 0.3s ease; }
    .student-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); background: white; }
    /* Custom style for the select dropdown to match your theme */
    .filter-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1.5em 1.5em;
    }
  </style>
</head>
<body class="p-10">

<nav class="flex flex-col lg:flex-row justify-between items-center mb-10 bg-white p-6 rounded-3xl shadow-sm border border-slate-100 gap-4">
    <div class="flex items-center gap-4">
        <a href="index.html" class="bg-slate-900 text-white px-4 py-2 rounded-xl font-bold text-sm hover:bg-blue-600 transition-all"><i class="fas fa-arrow-left mr-2"></i> Dashboard</a>
        <h1 class="text-xl font-extrabold text-slate-800">Student Directory</h1>
    </div>
    
    <div class="flex flex-wrap items-center gap-4 w-full lg:w-auto justify-end">
        <div class="relative min-w-[180px]">
            <select id="classFilter" class="filter-select w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm font-bold text-slate-600 outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer">
                <option value="all">All Classes</option>
                </select>
        </div>

        <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
            <input type="text" id="searchInput" placeholder="Search students..." class="bg-slate-50 border border-slate-200 rounded-xl pl-9 pr-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 min-w-[250px]">
        </div>
        
        <a href="newstudent.html" onclick="localStorage.removeItem('editStudentId')" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold text-sm shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all">
            <i class="fas fa-plus mr-2"></i>Add Student
        </a>
    </div>
</nav>

<div class="bg-white/50 rounded-[2.5rem] border border-white p-4 shadow-xl">
    <table class="w-full border-separate border-spacing-y-3">
        <thead>
            <tr class="text-left text-[10px] font-black uppercase tracking-widest text-slate-400">
                <th class="px-8">Profile</th>
                <th class="text-center">Grade</th>
                <th>Financial Overview</th>
                <th class="text-center">Status</th>
                <th class="text-right px-8">Actions</th>
            </tr>
        </thead>
        <tbody id="list"></tbody>
    </table>
    <div id="noResults" class="hidden py-20 text-center text-slate-400 font-bold">
        <i class="fas fa-user-slash block text-4xl mb-4 opacity-20"></i>
        No students found matching your criteria.
    </div>
</div>

<script>
let allStudents = [];

/* ===============================
   1. LOAD STUDENTS
================================ */
async function loadStudents() {
    try {
        const r = await fetch("http://localhost:3000/students");
        if (!r.ok) throw new Error("Server error");
        allStudents = await r.json();

        setupClassFilter();
        renderList(allStudents);
    } catch (err) {
        console.error("Fetch Error:", err);
        document.getElementById("list").innerHTML =
            `<tr>
                <td colspan="5" class="p-10 text-center text-red-500 font-bold">
                    Backend Connection Failed! Ensure server is running on port 3000.
                </td>
            </tr>`;
    }
}

/* ===============================
   2. CLASS FILTER SETUP
================================ */
function setupClassFilter() {
    const classFilter = document.getElementById("classFilter");
    const classes = [...new Set(allStudents.map(s => s.class_name))].sort();

    classFilter.innerHTML = '<option value="all">All Classes</option>';

    classes.forEach(cls => {
        if (cls) {
            const option = document.createElement("option");
            option.value = cls;
            option.textContent = cls;
            classFilter.appendChild(option);
        }
    });
}

/* ===============================
   3. RENDER STUDENT LIST
================================ */
function renderList(students) {
    const list = document.getElementById("list");
    const noResults = document.getElementById("noResults");
    list.innerHTML = "";

    if (students.length === 0) {
        noResults.classList.remove("hidden");
        return;
    } else {
        noResults.classList.add("hidden");
    }

    students.forEach(s => {
        const paid = Number(s.paid_fee || 0);
        const total = Number(s.total_fee || 0);
        const balance = total - paid;
        const progress = total > 0 ? (paid / total) * 100 : 0;

        list.innerHTML += `
        <tr class="student-card bg-white/70 shadow-sm rounded-2xl overflow-hidden">
            <td class="px-8 py-5 rounded-l-3xl cursor-pointer"
                onclick="window.location.href='invoice.html?student_id=${s.id}'">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-blue-600 text-white flex items-center justify-center font-bold">
                        ${s.name.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <div class="font-bold text-slate-800 text-sm">${s.name}</div>
                        <div class="text-[11px] text-slate-400">
                            <i class="fas fa-phone-alt mr-1"></i>${s.phone}
                        </div>
                    </div>
                </div>
            </td>

            <td class="text-center">
                <span class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-xl text-[10px] font-black uppercase">
                    ${s.class_name}
                </span>
            </td>

            <td>
                <div class="w-40 flex flex-col gap-1">
                    <div class="flex justify-between text-[9px] font-bold text-slate-400 uppercase">
                        <span>Paid: ₹${paid.toLocaleString()}</span>
                        <span>Total: ₹${total.toLocaleString()}</span>
                    </div>
                    <div class="h-1.5 w-full bg-slate-100 rounded-full">
                        <div class="bg-blue-500 h-full" style="width:${progress}%"></div>
                    </div>
                    <span class="text-[9px] font-bold ${balance > 0 ? 'text-red-400' : 'text-emerald-500'} uppercase">
                        ${balance > 0 ? `Remaining: ₹${balance.toLocaleString()}` : 'Fully Paid'}
                    </span>
                </div>
            </td>

            <td class="text-center">
                ${balance <= 0
                    ? `<span class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-lg text-[10px] font-black uppercase">
                        <i class="fas fa-check-circle mr-1"></i> Settled
                       </span>`
                    : `<span class="bg-orange-50 text-orange-600 px-3 py-1 rounded-lg text-[10px] font-black uppercase">
                        <i class="fas fa-clock mr-1"></i> Pending
                       </span>`
                }
            </td>

            <td class="px-8 text-right rounded-r-3xl">
                <div class="flex justify-end gap-2">

                    <!-- PAY -->
                    <button onclick="payFee(${s.id})"
                        class="w-9 h-9 bg-blue-50 text-blue-600 rounded-xl hover:bg-blue-600 hover:text-white">
                        <i class="fas fa-wallet"></i>
                    </button>

                    <!-- EDIT -->
                    <button onclick="editStudent(${s.id})"
                        class="w-9 h-9 bg-slate-50 text-slate-400 rounded-xl hover:bg-slate-800 hover:text-white">
                        <i class="fas fa-pen"></i>
                    </button>

                    <!-- DELETE -->
                    <button onclick="deleteStudent(${s.id}, '${s.name}')"
                        class="w-9 h-9 bg-red-50 text-red-500 rounded-xl hover:bg-red-600 hover:text-white">
                        <i class="fas fa-trash"></i>
                    </button>

                </div>
            </td>
        </tr>`;
    });
}

/* ===============================
   4. FILTERS
================================ */
function applyFilters() {
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();
    const classTerm = document.getElementById("classFilter").value;

    const filtered = allStudents.filter(s =>
        (s.name.toLowerCase().includes(searchTerm) || s.phone.includes(searchTerm)) &&
        (classTerm === "all" || s.class_name === classTerm)
    );

    renderList(filtered);
}

/* ===============================
   5. ACTIONS
================================ */
function payFee(id) {
    localStorage.setItem("feeStudentId", id);
    window.location.href = `Pay fee.html?student_id=${id}`;
}

function editStudent(id) {
    localStorage.setItem("editStudentId", id);
    window.location.href = "newstudent.html";
}

/* ===============================
   6. DELETE STUDENT (ADMIN)
================================ */
async function deleteStudent(id, name) {
    const confirmDelete = confirm(
        `⚠️ DELETE STUDENT?\n\nName: ${name}\n\nThis will permanently remove:\n• Student details\n• Fee records\n\nThis action CANNOT be undone.`
    );

    if (!confirmDelete) return;

    try {
        const res = await fetch(`http://localhost:3000/students/${id}`, {
            method: "DELETE"
        });

        const result = await res.json();

        if (result.success) {
            alert("✅ Student deleted successfully");
            allStudents = allStudents.filter(s => s.id !== id);
            applyFilters();
        } else {
            alert("❌ Delete failed");
        }
    } catch (err) {
        alert("❌ Server connection failed");
    }
}

/* ===============================
   7. EVENTS
================================ */
document.getElementById("searchInput").addEventListener("input", applyFilters);
document.getElementById("classFilter").addEventListener("change", applyFilters);

/* INIT */
loadStudents();
</script>

</body>
</html>
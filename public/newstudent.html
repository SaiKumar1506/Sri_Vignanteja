<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vignanateja EM | Add-Edit Student</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body class="bg-slate-50 min-h-screen font-sans">

  <!-- ===== HEADER (UNCHANGED) ===== -->
  <header class="bg-white shadow-sm border-b sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="bg-blue-600 text-white p-2 rounded-lg">
          <i class="fas fa-user-plus"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold text-slate-800" id="pageTitle">Add New Student</h1>
          <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">
            Student Management System
          </p>
        </div>
      </div>

      <a href="index.html"
        class="group flex items-center gap-2 px-4 py-2 rounded-xl border bg-white hover:bg-slate-50 transition font-semibold text-slate-600">
        <i class="fas fa-arrow-left text-sm group-hover:-translate-x-1 transition-transform"></i>
        Back to Dashboard
      </a>
    </div>
  </header>

  <!-- ===== MAIN (UNCHANGED UI) ===== -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <div class="grid lg:grid-cols-3 gap-8">

      <div class="lg:col-span-2 space-y-6">
        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8">

          <form id="studentForm" class="space-y-5">

            <!-- Basic Fields -->
            <div class="grid md:grid-cols-2 gap-5">
              <div>
                <label class="text-sm font-bold text-slate-700 ml-1">Student Full Name</label>
                <input id="stuName" required class="w-full p-3.5 bg-slate-50 border rounded-2xl">
              </div>
              <div>
                <label class="text-sm font-bold text-slate-700 ml-1">Parent Name</label>
                <input id="parentName" required class="w-full p-3.5 bg-slate-50 border rounded-2xl">
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-5">
              <div>
                <label class="text-sm font-bold text-slate-700 ml-1">Parent Contact Number</label>
                <input id="stuPhone" required maxlength="10" class="w-full p-3.5 bg-slate-50 border rounded-2xl">
              </div>
              <div>
                <label class="text-sm font-bold text-slate-700 ml-1">Assigned Class</label>
                <select id="stuClass" required class="w-full p-3.5 bg-slate-50 border rounded-2xl">
                  <option value="">Choose Class...</option>
                  <option>LKG Visista</option>
                  <option>UKG Vinaya</option>
                  <option>Class 1-Vishnu</option>
                </select>
              </div>
            </div>

            <div>
              <label class="text-sm font-bold text-slate-700 ml-1">Address</label>
              <textarea id="stuAddress" required rows="3"
                class="w-full p-3.5 bg-slate-50 border rounded-2xl"></textarea>
            </div>

            <!-- Fee -->
            <div>
              <div class="flex justify-between items-center">
                <h3 class="font-bold text-slate-700">Total Fee</h3>
                <button type="button" id="addTotalFee" class="text-blue-600 text-sm">
                  <i class="fas fa-plus"></i> Add Fee Item
                </button>
              </div>

              <div id="totalFeeContainer" class="space-y-3 mt-3"></div>

              <div class="mt-3 p-3 bg-blue-50 rounded-xl flex justify-between">
                <span class="font-bold">Total Amount:</span>
                <span id="totalFeeSum" class="font-bold">₹0</span>
              </div>

              <input type="hidden" id="stuTotal" value="0">
            </div>

            <button
              class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold">
              Save Student Record
            </button>

          </form>
        </div>
      </div>

      <!-- ===== PREVIEW (UNCHANGED) ===== -->
      <div class="bg-blue-600 rounded-3xl p-6 text-white">
        <p id="prevName" class="text-2xl font-bold">Student Name</p>
        <p>Parent: <span id="prevParentName">-</span></p>
        <p id="prevClass">Class:</p>
        <p id="prevAddress">Address</p>
        <p id="prevBalance" class="text-xl font-bold">₹0</p>
      </div>

    </div>
  </main>

<script>
/* ================= HELPERS ================= */
function getStudentIdFromURL() {
  return new URLSearchParams(window.location.search).get("id");
}

const API = "https://sri-vignanteja.onrender.com";

/* ================= ELEMENTS ================= */
const form = document.getElementById("studentForm");
const nameInput = document.getElementById("stuName");
const parentNameInput = document.getElementById("parentName");
const phoneInput = document.getElementById("stuPhone");
const classSelect = document.getElementById("stuClass");
const addressInput = document.getElementById("stuAddress");
const totalFeeInput = document.getElementById("stuTotal");

const totalFeeContainer = document.getElementById("totalFeeContainer");
const totalFeeSum = document.getElementById("totalFeeSum");

const prevName = document.getElementById("prevName");
const prevParent = document.getElementById("prevParentName");
const prevClass = document.getElementById("prevClass");
const prevAddress = document.getElementById("prevAddress");
const prevBalance = document.getElementById("prevBalance");

/* ================= FEE ================= */
function createFeeItem() {
  const div = document.createElement("div");
  div.innerHTML = `
    <input type="number" class="fee w-full p-2 border rounded" placeholder="Amount">
  `;
  div.querySelector(".fee").addEventListener("input", updateTotal);
  totalFeeContainer.appendChild(div);
}

function updateTotal() {
  let total = 0;
  document.querySelectorAll(".fee").forEach(f => total += Number(f.value || 0));
  totalFeeInput.value = total;
  totalFeeSum.innerText = `₹${total}`;
  prevBalance.innerText = `₹${total}`;
}

/* ================= PREVIEW ================= */
function updatePreview() {
  prevName.innerText = nameInput.value || "Student Name";
  prevParent.innerText = parentNameInput.value || "-";
  prevClass.innerText = classSelect.value || "";
  prevAddress.innerText = addressInput.value || "";
}

/* ================= SUBMIT ================= */
form.addEventListener("submit", async e => {
  e.preventDefault();

  const id = getStudentIdFromURL();

  const payload = {
    name: nameInput.value,
    parent_name: parentNameInput.value,
    phone: phoneInput.value,
    class_name: classSelect.value,
    address: addressInput.value,
    total_fee: Number(totalFeeInput.value)
  };

  const url = id
    ? `${API}/students/update/${id}`
    : `${API}/students/add`;

  await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  window.location.href = "list.html";
});

/* ================= EDIT MODE ================= */
const editId = getStudentIdFromURL();

if (editId) {
  document.getElementById("pageTitle").innerText = "Edit Student Profile";

  fetch(`${API}/students/${editId}`)
    .then(r => r.json())
    .then(s => {
      nameInput.value = s.name;
      parentNameInput.value = s.parent_name;
      phoneInput.value = s.phone;
      classSelect.value = s.class_name;
      addressInput.value = s.address;
      totalFeeInput.value = s.total_fee || 0;
      totalFeeSum.innerText = `₹${s.total_fee || 0}`;
      prevBalance.innerText = `₹${s.total_fee || 0}`;
      updatePreview();
    });
}

/* INIT */
document.getElementById("addTotalFee").addEventListener("click", createFeeItem);
createFeeItem();
updatePreview();
</script>

</body>
</html>
